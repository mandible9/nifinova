{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">NIFINOVA AI</h1>
                    <span class="ml-3 px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">Live Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="marketStatus" class="px-3 py-1 rounded-full text-sm font-medium">
                        <span class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2" id="statusDot"></span>
                            <span id="statusText">Loading...</span>
                        </span>
                    </div>
                    <span class="text-gray-600">Welcome, {{ session.username }}</span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Flash Message Banner -->
    <div id="flashBanner" class="hidden">
        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-3 px-4">
            <div class="max-w-7xl mx-auto flex items-center justify-center">
                <span class="text-lg font-bold" id="flashMessage">Loading...</span>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Market Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Nifty 50</p>
                        <p class="text-2xl font-bold text-gray-900" id="niftyPrice">₹0.00</p>
                        <p class="text-sm" id="niftyChange">+0.00 (0.00%)</p>
                    </div>
                    <div class="text-right">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" id="sentimentBadge">
                                NEUTRAL
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-xs text-gray-500">Volume: <span id="niftyVolume">0</span></p>
                    <p class="text-xs text-gray-500">Last Updated: <span id="lastUpdated">--</span></p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Signals</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeSignals">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Success Rate</p>
                        <p class="text-2xl font-bold text-gray-900" id="successRate">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">WhatsApp Users</p>
                        <p class="text-2xl font-bold text-gray-900" id="whatsappUsers">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-6a2 2 0 012-2h8z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Flash Alert Bar -->
        <div id="newsFlashBar" class="hidden mb-6">
            <div class="bg-gradient-to-r from-red-500 to-orange-500 text-white p-4 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="animate-pulse">
                            <span class="text-2xl">🚨</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg">BREAKING NEWS</h4>
                            <p id="newsFlashText" class="text-sm opacity-90"></p>
                        </div>
                    </div>
                    <button onclick="hideNewsFlash()" class="text-white hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Trading Signals -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Latest AI Signals</h3>
                            <p class="text-sm text-gray-600">Real-time trading signals powered by AI</p>
                        </div>
                        <button onclick="loadNewsFlash()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200">
                            📰 News Flash
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="signalsContainer" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            Loading signals...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options Chain & News -->
            <div class="space-y-6">
                <!-- Options Chain -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Options Chain</h3>
                        <p class="text-sm text-gray-600">Live Nifty 50 options data</p>
                    </div>
                    <div class="p-6">
                        <div id="optionsContainer" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                Loading options...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- News Flash -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">News Flash</h3>
                                <p class="text-sm text-gray-600">Breaking market news</p>
                            </div>
                            <button onclick="checkNews()" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200">
                                🔄 Refresh
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="newsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center py-4 text-gray-500">
                                Loading news...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Next Day Prediction Section -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md p-6 mb-6 border border-blue-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">🔮 Next Day Market Prediction</h2>
                <div class="flex space-x-2">
                    <button onclick="generatePrediction()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                        Generate Prediction
                    </button>
                    <button onclick="loadNextDayPrediction()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                        Refresh
                    </button>
                </div>
            </div>

            <div id="predictionContainer" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <div class="mb-2">📊</div>
                    <div>Next-day prediction will be available after market close</div>
                </div>
            </div>
        </div>

        <!-- Trading Strategies Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">🎯 AI Trading Strategies</h2>
                <button onclick="refreshStrategies()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    Refresh Analysis
                </button>
            </div>

            <div id="strategiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Strategies will be loaded here -->
            </div>
        </div>

        <!-- WhatsApp Management -->
        <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">WhatsApp Notifications</h3>
                <p class="text-sm text-gray-600">Manage users receiving trading alerts</p>
            </div>
            <div class="p-6">
                <div class="flex space-x-4 mb-6">
                    <input type="tel" id="phoneInput" placeholder="+91XXXXXXXXXX" 
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="addWhatsAppUser()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
                        Add User
                    </button>
                </div>
                <div id="whatsappUsersContainer" class="space-y-2">
                    <div class="text-center py-4 text-gray-500">
                        Loading WhatsApp users...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    let isConnected = false;

    // Socket connection
    socket.on('connect', function() {
        console.log('Connected to real-time updates');
        isConnected = true;
        updateConnectionStatus(true);
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
        isConnected = false;
        updateConnectionStatus(false);
    });

    socket.on('market_update', function(data) {
        console.log('Market update received:', data);
        updateNiftyData(data.nifty_data);
        updateSignals(data.new_signals);
        updateOptionsChain(data.options_chain);
    });

    socket.on('news_flash', function(data) {
        console.log('News flash received:', data);
        showNewsFlash(data.news);
        loadNewsFlash(); // Refresh news list
    });

    function updateConnectionStatus(connected) {
        const statusDot = document.getElementById('statusDot');
        if (connected) {
            statusDot.className = 'w-2 h-2 rounded-full mr-2 bg-green-500';
        } else {
            statusDot.className = 'w-2 h-2 rounded-full mr-2 bg-red-500';
        }
    }

    function updateMarketStatus(status) {
        const statusElement = document.getElementById('marketStatus');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        let bgClass = 'bg-gray-100 text-gray-800';
        let dotClass = 'w-2 h-2 rounded-full mr-2 bg-gray-500';

        switch(status) {
            case 'OPEN':
                bgClass = 'bg-green-100 text-green-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-green-500';
                statusText.textContent = 'Market Open';
                break;
            case 'CLOSED':
                bgClass = 'bg-red-100 text-red-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-red-500';
                statusText.textContent = 'Market Closed';
                break;
            case 'PRE_MARKET':
                bgClass = 'bg-yellow-100 text-yellow-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-yellow-500';
                statusText.textContent = 'Pre-Market';
                break;
            case 'WEEKEND':
                bgClass = 'bg-blue-100 text-blue-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-blue-500';
                statusText.textContent = 'Weekend';
                break;
        }

        statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${bgClass}`;
        statusDot.className = dotClass;
    }

    function updateNiftyData(data) {
        document.getElementById('niftyPrice').textContent = `₹${data.price.toFixed(2)}`;

        const changeElement = document.getElementById('niftyChange');
        const changeColor = data.change >= 0 ? 'text-green-600' : 'text-red-600';
        const changeSign = data.change >= 0 ? '+' : '';
        changeElement.textContent = `${changeSign}${data.change.toFixed(2)} (${changeSign}${data.change_percent.toFixed(2)}%)`;
        changeElement.className = `text-sm ${changeColor}`;

        document.getElementById('niftyVolume').textContent = data.volume.toLocaleString();
        document.getElementById('lastUpdated').textContent = new Date(data.last_updated).toLocaleTimeString();

        // Update market status
        updateMarketStatus(data.market_status);

        // Update sentiment
        updateSentiment(data.sentiment);

        // Update flash message
        updateFlashMessage(data.flash_message);
    }

    function updateSentiment(sentiment) {
        const sentimentBadge = document.getElementById('sentimentBadge');
        let badgeClass = 'bg-gray-100 text-gray-800';

        switch(sentiment) {
            case 'BULLISH':
                badgeClass = 'bg-green-100 text-green-800';
                break;
            case 'BEARISH':
                badgeClass = 'bg-red-100 text-red-800';
                break;
            case 'NEUTRAL':
                badgeClass = 'bg-gray-100 text-gray-800';
                break;
        }

        sentimentBadge.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}`;
        sentimentBadge.textContent = sentiment;
    }

    function updateFlashMessage(message) {
        const flashBanner = document.getElementById('flashBanner');
        const flashMessage = document.getElementById('flashMessage');

        if (message && message.trim() !== '') {
            flashMessage.textContent = message;
            flashBanner.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                flashBanner.classList.add('hidden');
            }, 5000);
        }
    }

    function updateSignals(newSignals) {
        if (newSignals && newSignals.length > 0) {
            loadSignals();
        }
    }

    function updateOptionsChain(data) {
        const container = document.getElementById('optionsContainer');

        // Handle new API response format
        const options = data.options || data;
        const marketStatus = data.market_status || 'UNKNOWN';
        const dataAvailable = data.data_available !== undefined ? data.data_available : (options && options.length > 0);
        const message = data.message || '';

        if (!dataAvailable || !options || options.length === 0) {
            const statusMessage = marketStatus !== 'OPEN' 
                ? `Market is ${marketStatus.replace('_', ' ').toLowerCase()} - No real options data available`
                : 'No options data available';

            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-gray-500 mb-2">${statusMessage}</div>
                    ${message ? `<div class="text-sm text-gray-400">${message}</div>` : ''}
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg text-blue-700 text-sm">
                        <i class="fas fa-info-circle mr-2"></i>
                        Real-time options data will be shown when market is live
                    </div>
                </div>
            `;
            return;
        }

        const html = `
            <div class="mb-3 flex justify-between items-center">
                <span class="text-sm text-green-600 font-medium">
                    <i class="fas fa-circle text-green-500 mr-1"></i>
                    Live Options Data
                </span>
                <span class="text-xs text-gray-500">Market: ${marketStatus.replace('_', ' ')}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-xs uppercase">
                            <th class="px-3 py-2 text-left">Call LTP</th>
                            <th class="px-3 py-2 text-left">Call Vol</th>
                            <th class="px-3 py-2 text-center font-bold">Strike</th>
                            <th class="px-3 py-2 text-right">Put Vol</th>
                            <th class="px-3 py-2 text-right">Put LTP</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${options.map(option => `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="px-3 py-2 text-green-600 font-medium">₹${option.call_ltp.toFixed(2)}</td>
                                <td class="px-3 py-2 text-gray-600">${option.call_volume.toLocaleString()}</td>
                                <td class="px-3 py-2 text-center font-bold bg-yellow-50">${option.strike_price}</td>
                                <td class="px-3 py-2 text-right text-gray-600">${option.put_volume.toLocaleString()}</td>
                                <td class="px-3 py-2 text-right text-red-600 font-medium">₹${option.put_ltp.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    }

    function loadMarketOverview() {
        fetch('/api/market/overview')
            .then(response => response.json())
            .then(data => {
                updateNiftyData(data.nifty50);
                document.getElementById('activeSignals').textContent = data.active_signals;
                document.getElementById('successRate').textContent = `${data.success_rate}%`;
                document.getElementById('whatsappUsers').textContent = data.whatsapp_users;
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    }

    function loadSignals() {
        fetch('/api/signals')
            .then(response => response.json())
            .then(signals => {
                const container = document.getElementById('signalsContainer');

                if (signals.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No signals available</div>';
                    return;
                }

                const html = signals.slice(0, 10).map(signal => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="px-2 py-1 text-xs font-medium rounded ${signal.type === 'CALL' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${signal.type}
                                </span>
                                <span class="text-lg font-semibold">₹${signal.strike_price}</span>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${signal.confidence >= 80 ? 'bg-green-100 text-green-800' : signal.confidence >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${signal.confidence}%
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                            <div>
                                <span class="text-gray-600">Target:</span>
                                <span class="font-medium text-green-600">₹${signal.target_price}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Stop Loss:</span>
                                <span class="font-medium text-red-600">₹${signal.stop_loss}</span>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mb-2">${signal.reasoning}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>Expiry: ${signal.expiry_date}</span>
                            <span>${new Date(signal.created_at).toLocaleTimeString()}</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading signals:', error);
                document.getElementById('signalsContainer').innerHTML = '<div class="text-center py-8 text-red-500">Error loading signals</div>';
            });
    }

    function loadOptionsChain() {
        fetch('/api/options-chain')
            .then(response => response.json())
            .then(options => {
                updateOptionsChain(options);
            })
            .catch(error => {
                console.error('Error loading options chain:', error);
            });
    }

    function loadWhatsAppUsers() {
        fetch('/api/whatsapp/users')
            .then(response => response.json())
            .then(users => {
                const container = document.getElementById('whatsappUsersContainer');

                if (users.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">No WhatsApp users registered</div>';
                    return;
                }

                const html = users.map(user => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-medium">${user.phone_number}</span>
                        <button onclick="removeWhatsAppUser('${user.phone_number}')" 
                                class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                    </div>
                `).join('');

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading WhatsApp users:', error);
            });
    }

    function addWhatsAppUser() {
        const phoneInput = document.getElementById('phoneInput');
        const phoneNumber = phoneInput.value.trim();

        if (!phoneNumber) {
            alert('Please enter a phone number');
            return;
        }

        fetch('/api/whatsapp/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({phone_number: phoneNumber})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                phoneInput.value = '';
                loadWhatsAppUsers();
                loadMarketOverview();
            }
        })
        .catch(error => {
            console.error('Error adding user:', error);
            alert('Error adding user');
        });
    }

    function removeWhatsAppUser(phoneNumber) {
        if (!confirm('Remove this user from WhatsApp notifications?')) {
            return;
        }

        fetch(`/api/whatsapp/users/${encodeURIComponent(phoneNumber)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadWhatsAppUsers();
                loadMarketOverview();
            } else {
                alert('Error removing user');
            }
        })
        .catch(error => {
            console.error('Error removing user:', error);
            alert('Error removing user');
        });
    }

    function showNewsFlash(news) {
        const flashBar = document.getElementById('newsFlashBar');
        const flashText = document.getElementById('newsFlashText');

        const impactEmoji = news.impact === 'HIGH' ? '🚨' : news.impact === 'MEDIUM' ? '⚠️' : 'ℹ️';
        const sentimentEmoji = news.sentiment === 'POSITIVE' ? '📈' : news.sentiment === 'NEGATIVE' ? '📉' : '📊';

        flashText.innerHTML = `${impactEmoji} ${sentimentEmoji} ${news.headline} - ${news.market_reaction}`;
        flashBar.classList.remove('hidden');

        // Auto-hide after 15 seconds for medium impact, 30 for high impact
        const hideTime = news.impact === 'HIGH' ? 30000 : 15000;
        setTimeout(() => {
            flashBar.classList.add('hidden');
        }, hideTime);
    }

    function hideNewsFlash() {
        document.getElementById('newsFlashBar').classList.add('hidden');
    }

    function loadNewsFlash() {
        fetch('/api/news/flash')
            .then(response => response.json())
            .then(news => {
                const container = document.getElementById('newsContainer');
                if (news.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">No recent news flashes</div>';
                    return;
                }

                const html = news.slice(0, 10).map(item => {
                    const impactColor = item.impact === 'HIGH' ? 'text-red-600' : item.impact === 'MEDIUM' ? 'text-yellow-600' : 'text-blue-600';
                    const sentimentColor = item.sentiment === 'POSITIVE' ? 'text-green-600' : item.sentiment === 'NEGATIVE' ? 'text-red-600' : 'text-gray-600';
                    const categoryEmoji = {
                        'WAR': '⚔️',
                        'ECONOMY': '💰',
                        'POLITICS': '🏛️',
                        'CORPORATE': '🏢',
                        'GLOBAL': '🌍',
                        'GENERAL': '📰'
                    }[item.category] || '📰';

                    return `
                        <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                            <div class="flex items-start justify-between mb-2">
                                <span class="px-2 py-1 text-xs font-medium rounded ${impactColor.replace('text-', 'bg-').replace('-600', '-100')} ${impactColor}">
                                    ${item.impact}
                                </span>
                                <span class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleTimeString()}</span>
                            </div>

                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-lg">${categoryEmoji}</span>
                                <span class="text-xs font-medium text-gray-600">${item.category}</span>
                                <span class="text-xs ${sentimentColor}">${item.sentiment}</span>
                            </div>

                            <h4 class="text-sm font-semibold text-gray-900 mb-1">${item.headline}</h4>
                            <p class="text-xs text-gray-600 mb-2">${item.market_reaction}</p>

                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">${item.source}</span>
                                <a href="${item.url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">Read more →</a>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading news:', error);
                document.getElementById('newsContainer').innerHTML = '<div class="text-center py-4 text-red-500">Error loading news</div>';
            });
    }

    function checkNews() {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Checking...';

        fetch('/api/news/check')
            .then(response => response.json())
            .then(data => {
                console.log(`Found ${data.new_flashes} new flashes`);
                loadNewsFlash();
                if (data.new_flashes > 0) {
                    alert(`Found ${data.new_flashes} new breaking news!`);
                }
            })
            .catch(error => {
                console.error('Error checking news:', error);
                alert('Error checking news');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
    }

    // Load trading strategies
    function loadTradingStrategies() {
        fetch('/api/trading/strategies')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('strategiesContainer');
                const strategies = data.strategies || [];

                if (strategies.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-4">No strategy analysis available</p>';
                    return;
                }

                container.innerHTML = strategies.map(strategy => {
                    const strategyEmoji = {
                        'SCALPING': '⚡',
                        'INTRADAY': '📈',
                        'BTST': '🌙',
                        'POSITIONAL': '📊'
                    }[strategy.strategy_type] || '📈';

                    const riskColor = {
                        'LOW': 'green',
                        'MEDIUM': 'yellow',
                        'HIGH': 'red'
                    }[strategy.risk_level] || 'gray';

                    const bgColor = strategy.recommended ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200';
                    const textColor = strategy.recommended ? 'text-green-800' : 'text-gray-600';

                    return `
                        <div class="border-2 ${bgColor} rounded-lg p-4 ${textColor}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-2">${strategyEmoji}</span>
                                    <h3 class="font-bold text-sm">${strategy.strategy_type}</h3>
                                </div>
                                <span class="text-xs bg-${riskColor}-100 text-${riskColor}-800 px-2 py-1 rounded">
                                    ${strategy.risk_level}
                                </span>
                            </div>

                            <div class="mb-3">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs">Confidence</span>
                                    <span class="text-xs font-bold">${strategy.confidence}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${strategy.confidence}%"></div>
                                </div>
                            </div>

                            <div class="text-xs mb-2">
                                <strong>Duration:</strong> ${strategy.target_duration}
                            </div>

                            <div class="text-xs mb-2">
                                <strong>Capital:</strong> ${strategy.capital_allocation}
                            </div>

                            <div class="text-xs mb-2">
                                <strong>Logic:</strong> ${strategy.reasoning}
                            </div>

                            <div class="mt-3 pt-2 border-t border-gray-200">
                                ${strategy.recommended 
                                    ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">✅ RECOMMENDED</span>'
                                    : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">⏸️ WAIT</span>'
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                document.getElementById('strategiesContainer').innerHTML = '<p class="text-red-500 text-center py-4 col-span-4">Error loading strategies</p>';
            });
    }

    // Refresh strategies manually
    function refreshStrategies() {
        loadTradingStrategies();
    }

    // Load next-day prediction
    function loadNextDayPrediction() {
        fetch('/api/prediction/next-day')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('predictionContainer');

                if (!data.available) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="mb-2">📊</div>
                            <div>${data.message}</div>
                            <div class="text-sm mt-2">Market Status: ${data.market_status.replace('_', ' ')}</div>
                        </div>
                    `;
                    return;
                }

                const prediction = data.prediction;
                const directionColor = prediction.direction === 'BULLISH' ? 'text-green-600' : prediction.direction === 'BEARISH' ? 'text-red-600' : 'text-gray-600';
                const directionBg = prediction.direction === 'BULLISH' ? 'bg-green-100' : prediction.direction === 'BEARISH' ? 'bg-red-100' : 'bg-gray-100';
                const confidenceColor = prediction.confidence > 80 ? 'text-green-600' : prediction.confidence > 60 ? 'text-yellow-600' : 'text-red-600';

                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Prediction -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-lg p-6 shadow-sm border">
                                <div class="text-center mb-4">
                                    <div class="text-3xl mb-2">
                                        ${prediction.direction === 'BULLISH' ? '🚀' : prediction.direction === 'BEARISH' ? '📉' : '↔️'}
                                    </div>
                                    <h3 class="text-xl font-bold ${directionColor}">${prediction.direction}</h3>
                                    <p class="text-sm text-gray-600">for ${prediction.prediction_date}</p>
                                </div>

                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Confidence:</span>
                                        <span class="font-semibold ${confidenceColor}">${prediction.confidence}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Probability Up:</span>
                                        <span class="font-semibold">${prediction.probability_up}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Market Regime:</span>
                                        <span class="font-semibold">${prediction.market_regime}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Volatility:</span>
                                        <span class="font-semibold">${prediction.volatility_outlook}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Price Targets & Analysis -->
                        <div class="lg:col-span-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- Price Targets -->
                                <div class="bg-white rounded-lg p-4 shadow-sm border">
                                    <h4 class="font-semibold text-gray-800 mb-3">💹 Price Targets</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Expected High:</span>
                                            <span class="font-medium text-green-600">₹${prediction.price_targets.high}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Expected Low:</span>
                                            <span class="font-medium text-red-600">₹${prediction.price_targets.low}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Range:</span>
                                            <span class="font-medium">₹${prediction.price_targets.expected_range}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Key Drivers -->
                                <div class="bg-white rounded-lg p-4 shadow-sm border">
                                    <h4 class="font-semibold text-gray-800 mb-3">🔍 Key Drivers</h4>
                                    <div class="space-y-1 text-sm">
                                        ${prediction.key_drivers.map(driver => `
                                            <div class="text-gray-700">• ${driver}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Trading Recommendations -->
                            <div class="bg-white rounded-lg p-4 shadow-sm border">
                                <h4 class="font-semibold text-gray-800 mb-3">📋 Trading Recommendations</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${prediction.trading_recommendations.map(rec => {
                                        const riskColor = rec.risk_level === 'LOW' ? 'text-green-600' : rec.risk_level === 'HIGH' ? 'text-red-600' : 'text-yellow-600';
                                        return `
                                            <div class="border border-gray-200 rounded p-3">
                                                <div class="font-medium text-gray-800">${rec.strategy}</div>
                                                <div class="text-sm text-gray-600 mt-1">${rec.reasoning}</div>
                                                <div class="flex justify-between mt-2 text-xs">
                                                    <span class="${riskColor}">${rec.risk_level} Risk</span>
                                                    <span class="font-medium">${rec.allocation}</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            ${prediction.risk_factors && prediction.risk_factors.length > 0 ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                                    <h4 class="font-semibold text-yellow-800 mb-2">⚠️ Risk Factors</h4>
                                    <div class="space-y-1 text-sm text-yellow-700">
                                        ${prediction.risk_factors.map(risk => `<div>• ${risk}</div>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading prediction:', error);
                document.getElementById('predictionContainer').innerHTML = 
                    '<div class="text-center py-8 text-red-500">Error loading prediction</div>';
            });
    }

    // Generate new prediction
    function generatePrediction() {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'Generating...';

        fetch('/api/prediction/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNextDayPrediction();
            } else {
                alert('Error generating prediction: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error generating prediction:', error);
            alert('Error generating prediction');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = 'Generate Prediction';
        });
    }

    // Listen for real-time prediction updates
    socket.on('next_day_prediction', function(data) {
        console.log('Next-day prediction received:', data);
        loadNextDayPrediction();
    });

    // Initial load
    loadMarketOverview();
    loadSignals();
    loadOptionsChain();
    loadWhatsAppUsers();
    loadNewsFlash();
    loadTradingStrategies();
    loadNextDayPrediction();

    // Refresh data periodically
    setInterval(loadMarketOverview, 30000); // Every 30 seconds
    setInterval(loadSignals, 60000);        // Every minute
    setInterval(loadWhatsAppUsers, 300000); // Every 5 minutes
    setInterval(loadNewsFlash, 120000);     // Every 2 minutes
    setInterval(loadTradingStrategies, 45000); // Refresh strategies every 45 seconds
    setInterval(loadNextDayPrediction, 600000); // Refresh prediction every 10 minutes
</script>
{% endblock %}