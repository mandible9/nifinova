
{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">NIFINOVA AI</h1>
                    <span class="ml-3 px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">Live Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="marketStatus" class="px-3 py-1 rounded-full text-sm font-medium">
                        <span class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2" id="statusDot"></span>
                            <span id="statusText">Loading...</span>
                        </span>
                    </div>
                    <span class="text-gray-600">Welcome, {{ session.username }}</span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Flash Message Banner -->
    <div id="flashBanner" class="hidden">
        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-3 px-4">
            <div class="max-w-7xl mx-auto flex items-center justify-center">
                <span class="text-lg font-bold" id="flashMessage">Loading...</span>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Market Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Nifty 50</p>
                        <p class="text-2xl font-bold text-gray-900" id="niftyPrice">â‚¹0.00</p>
                        <p class="text-sm" id="niftyChange">+0.00 (0.00%)</p>
                    </div>
                    <div class="text-right">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" id="sentimentBadge">
                                NEUTRAL
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-xs text-gray-500">Volume: <span id="niftyVolume">0</span></p>
                    <p class="text-xs text-gray-500">Last Updated: <span id="lastUpdated">--</span></p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Signals</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeSignals">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Success Rate</p>
                        <p class="text-2xl font-bold text-gray-900" id="successRate">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">WhatsApp Users</p>
                        <p class="text-2xl font-bold text-gray-900" id="whatsappUsers">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-6a2 2 0 012-2h8z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Trading Signals -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Latest AI Signals</h3>
                    <p class="text-sm text-gray-600">Real-time trading signals powered by AI</p>
                </div>
                <div class="p-6">
                    <div id="signalsContainer" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            Loading signals...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options Chain -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Options Chain</h3>
                    <p class="text-sm text-gray-600">Live Nifty 50 options data</p>
                </div>
                <div class="p-6">
                    <div id="optionsContainer" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">
                            Loading options...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Management -->
        <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">WhatsApp Notifications</h3>
                <p class="text-sm text-gray-600">Manage users receiving trading alerts</p>
            </div>
            <div class="p-6">
                <div class="flex space-x-4 mb-6">
                    <input type="tel" id="phoneInput" placeholder="+91XXXXXXXXXX" 
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="addWhatsAppUser()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
                        Add User
                    </button>
                </div>
                <div id="whatsappUsersContainer" class="space-y-2">
                    <div class="text-center py-4 text-gray-500">
                        Loading WhatsApp users...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    let isConnected = false;

    // Socket connection
    socket.on('connect', function() {
        console.log('Connected to real-time updates');
        isConnected = true;
        updateConnectionStatus(true);
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
        isConnected = false;
        updateConnectionStatus(false);
    });

    socket.on('market_update', function(data) {
        console.log('Market update received:', data);
        updateNiftyData(data.nifty_data);
        updateSignals(data.new_signals);
        updateOptionsChain(data.options_chain);
    });

    function updateConnectionStatus(connected) {
        const statusDot = document.getElementById('statusDot');
        if (connected) {
            statusDot.className = 'w-2 h-2 rounded-full mr-2 bg-green-500';
        } else {
            statusDot.className = 'w-2 h-2 rounded-full mr-2 bg-red-500';
        }
    }

    function updateMarketStatus(status) {
        const statusElement = document.getElementById('marketStatus');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');
        
        let bgClass = 'bg-gray-100 text-gray-800';
        let dotClass = 'w-2 h-2 rounded-full mr-2 bg-gray-500';
        
        switch(status) {
            case 'OPEN':
                bgClass = 'bg-green-100 text-green-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-green-500';
                statusText.textContent = 'Market Open';
                break;
            case 'CLOSED':
                bgClass = 'bg-red-100 text-red-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-red-500';
                statusText.textContent = 'Market Closed';
                break;
            case 'PRE_MARKET':
                bgClass = 'bg-yellow-100 text-yellow-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-yellow-500';
                statusText.textContent = 'Pre-Market';
                break;
            case 'WEEKEND':
                bgClass = 'bg-blue-100 text-blue-800';
                dotClass = 'w-2 h-2 rounded-full mr-2 bg-blue-500';
                statusText.textContent = 'Weekend';
                break;
        }
        
        statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${bgClass}`;
        statusDot.className = dotClass;
    }

    function updateNiftyData(data) {
        document.getElementById('niftyPrice').textContent = `â‚¹${data.price.toFixed(2)}`;
        
        const changeElement = document.getElementById('niftyChange');
        const changeColor = data.change >= 0 ? 'text-green-600' : 'text-red-600';
        const changeSign = data.change >= 0 ? '+' : '';
        changeElement.textContent = `${changeSign}${data.change.toFixed(2)} (${changeSign}${data.change_percent.toFixed(2)}%)`;
        changeElement.className = `text-sm ${changeColor}`;
        
        document.getElementById('niftyVolume').textContent = data.volume.toLocaleString();
        document.getElementById('lastUpdated').textContent = new Date(data.last_updated).toLocaleTimeString();
        
        // Update market status
        updateMarketStatus(data.market_status);
        
        // Update sentiment
        updateSentiment(data.sentiment);
        
        // Update flash message
        updateFlashMessage(data.flash_message);
    }

    function updateSentiment(sentiment) {
        const sentimentBadge = document.getElementById('sentimentBadge');
        let badgeClass = 'bg-gray-100 text-gray-800';
        
        switch(sentiment) {
            case 'BULLISH':
                badgeClass = 'bg-green-100 text-green-800';
                break;
            case 'BEARISH':
                badgeClass = 'bg-red-100 text-red-800';
                break;
            case 'NEUTRAL':
                badgeClass = 'bg-gray-100 text-gray-800';
                break;
        }
        
        sentimentBadge.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}`;
        sentimentBadge.textContent = sentiment;
    }

    function updateFlashMessage(message) {
        const flashBanner = document.getElementById('flashBanner');
        const flashMessage = document.getElementById('flashMessage');
        
        if (message && message.trim() !== '') {
            flashMessage.textContent = message;
            flashBanner.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                flashBanner.classList.add('hidden');
            }, 5000);
        }
    }

    function updateSignals(newSignals) {
        if (newSignals && newSignals.length > 0) {
            loadSignals();
        }
    }

    function updateOptionsChain(optionsData) {
        const container = document.getElementById('optionsContainer');
        if (!optionsData || optionsData.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-gray-500">No options data available</div>';
            return;
        }

        const html = optionsData.slice(0, 5).map(option => `
            <div class="border border-gray-200 rounded-lg p-3">
                <div class="text-sm font-medium text-gray-900">â‚¹${option.strike_price}</div>
                <div class="grid grid-cols-2 gap-2 mt-2 text-xs">
                    <div>
                        <div class="text-gray-600">Call: â‚¹${option.call_ltp.toFixed(2)}</div>
                        <div class="text-gray-500">Vol: ${option.call_volume.toLocaleString()}</div>
                    </div>
                    <div>
                        <div class="text-gray-600">Put: â‚¹${option.put_ltp.toFixed(2)}</div>
                        <div class="text-gray-500">Vol: ${option.put_volume.toLocaleString()}</div>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    function loadMarketOverview() {
        fetch('/api/market/overview')
            .then(response => response.json())
            .then(data => {
                updateNiftyData(data.nifty50);
                document.getElementById('activeSignals').textContent = data.active_signals;
                document.getElementById('successRate').textContent = `${data.success_rate}%`;
                document.getElementById('whatsappUsers').textContent = data.whatsapp_users;
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    }

    function loadSignals() {
        fetch('/api/signals')
            .then(response => response.json())
            .then(signals => {
                const container = document.getElementById('signalsContainer');
                
                if (signals.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No signals available</div>';
                    return;
                }

                const html = signals.slice(0, 10).map(signal => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="px-2 py-1 text-xs font-medium rounded ${signal.type === 'CALL' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${signal.type}
                                </span>
                                <span class="text-lg font-semibold">â‚¹${signal.strike_price}</span>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${signal.confidence >= 80 ? 'bg-green-100 text-green-800' : signal.confidence >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${signal.confidence}%
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                            <div>
                                <span class="text-gray-600">Target:</span>
                                <span class="font-medium text-green-600">â‚¹${signal.target_price}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Stop Loss:</span>
                                <span class="font-medium text-red-600">â‚¹${signal.stop_loss}</span>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-2">${signal.reasoning}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>Expiry: ${signal.expiry_date}</span>
                            <span>${new Date(signal.created_at).toLocaleTimeString()}</span>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading signals:', error);
                document.getElementById('signalsContainer').innerHTML = '<div class="text-center py-8 text-red-500">Error loading signals</div>';
            });
    }

    function loadOptionsChain() {
        fetch('/api/options-chain')
            .then(response => response.json())
            .then(options => {
                updateOptionsChain(options);
            })
            .catch(error => {
                console.error('Error loading options chain:', error);
            });
    }

    function loadWhatsAppUsers() {
        fetch('/api/whatsapp/users')
            .then(response => response.json())
            .then(users => {
                const container = document.getElementById('whatsappUsersContainer');
                
                if (users.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">No WhatsApp users registered</div>';
                    return;
                }

                const html = users.map(user => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-medium">${user.phone_number}</span>
                        <button onclick="removeWhatsAppUser('${user.phone_number}')" 
                                class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading WhatsApp users:', error);
            });
    }

    function addWhatsAppUser() {
        const phoneInput = document.getElementById('phoneInput');
        const phoneNumber = phoneInput.value.trim();
        
        if (!phoneNumber) {
            alert('Please enter a phone number');
            return;
        }

        fetch('/api/whatsapp/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({phone_number: phoneNumber})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                phoneInput.value = '';
                loadWhatsAppUsers();
                loadMarketOverview();
            }
        })
        .catch(error => {
            console.error('Error adding user:', error);
            alert('Error adding user');
        });
    }

    function removeWhatsAppUser(phoneNumber) {
        if (!confirm('Remove this user from WhatsApp notifications?')) {
            return;
        }

        fetch(`/api/whatsapp/users/${encodeURIComponent(phoneNumber)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadWhatsAppUsers();
                loadMarketOverview();
            } else {
                alert('Error removing user');
            }
        })
        .catch(error => {
            console.error('Error removing user:', error);
            alert('Error removing user');
        });
    }

    function logout() {
        fetch('/logout', {method: 'POST'})
            .then(() => {
                window.location.href = '/login';
            });
    }

    // Initial load
    loadMarketOverview();
    loadSignals();
    loadOptionsChain();
    loadWhatsAppUsers();

    // Refresh data periodically
    setInterval(loadMarketOverview, 30000); // Every 30 seconds
    setInterval(loadSignals, 60000);        // Every minute
    setInterval(loadWhatsAppUsers, 300000); // Every 5 minutes
</script>
{% endblock %}
