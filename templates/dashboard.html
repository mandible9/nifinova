{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
    <!-- Enhanced Header -->
    <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-600 to-indigo-700 rounded-lg flex items-center justify-center shadow-lg">
                            <span class="text-white font-bold text-lg">N</span>
                        </div>
                        <div class="ml-3">
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">NIFINOVA AI</h1>
                            <p class="text-xs text-gray-500">by PKR SOLUTION</p>
                        </div>
                    </div>
                    <span class="ml-3 px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 animate-pulse">
                        üü¢ Live Dashboard
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="marketStatus" class="px-4 py-2 rounded-full text-sm font-medium border-2 transition-all duration-300">
                        <span class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2 animate-pulse" id="statusDot"></span>
                            <span id="statusText">Loading...</span>
                        </span>
                    </div>
                    <div class="text-right">
                        <span class="text-gray-600 text-sm">Welcome back,</span>
                        <div class="font-semibold text-gray-800">{{ session.username }}</div>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200 shadow-md">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('trading')" id="tab-trading" class="tab-button active border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600 whitespace-nowrap">
                    üìà Trading Dashboard
                </button>
                <button onclick="switchTab('analytics')" id="tab-analytics" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    üìä Analytics & Reports
                </button>
                <button onclick="switchTab('whatsapp')" id="tab-whatsapp" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    üí¨ WhatsApp Management
                </button>
                <button onclick="switchTab('api')" id="tab-api" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    üîå API Integration
                </button>
                <button onclick="switchTab('settings')" id="tab-settings" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    ‚öôÔ∏è Settings
                </button>
                <button onclick="switchTab('portfolio')" id="tab-portfolio" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    üíº Portfolio
                </button>
            </nav>
        </div>
    </div>

    <!-- Flash Message Banner -->
    <div id="flashBanner" class="hidden">
        <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white py-4 px-4 animate-pulse">
            <div class="max-w-7xl mx-auto flex items-center justify-center">
                <span class="text-lg font-bold animate-bounce mr-2">‚ö°</span>
                <span class="text-lg font-bold" id="flashMessage">Loading...</span>
            </div>
        </div>
    </div>

    <!-- News Flash Alert Bar -->
    <div id="newsFlashBar" class="hidden">
        <div class="bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 text-white p-4 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="animate-bounce">
                        <span class="text-3xl">üö®</span>
                    </div>
                    <div>
                        <h4 class="font-bold text-xl">BREAKING NEWS</h4>
                        <p id="newsFlashText" class="text-sm opacity-90"></p>
                    </div>
                </div>
                <button onclick="hideNewsFlash()" class="text-white hover:text-gray-200 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Trading Dashboard Tab -->
        <div id="trading-tab" class="tab-content active">

        <!-- Top Section: Market Overview -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="mr-3">üìä</span>
                Market Overview
            </h2>

            <!-- Market Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Nifty 50 Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Nifty 50</p>
                            <p class="text-3xl font-bold text-gray-900" id="niftyPrice">‚Çπ0.00</p>
                            <p class="text-sm font-medium" id="niftyChange">+0.00 (0.00%)</p>
                        </div>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center shadow-inner">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" id="sentimentBadge">
                                NEUTRAL
                            </span>
                        </div>
                        <div class="text-right text-xs text-gray-500">
                            <div>Vol: <span id="niftyVolume" class="font-medium">0</span></div>
                            <div id="lastUpdated">--</div>
                        </div>
                    </div>
                </div>

                <!-- Active Signals Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Active Signals</p>
                            <p class="text-3xl font-bold text-gray-900" id="activeSignals">0</p>
                            <p class="text-sm text-green-600 font-medium">AI Generated</p>
                        </div>
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center shadow-inner">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Success Rate Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Success Rate</p>
                            <p class="text-3xl font-bold text-gray-900" id="successRate">0%</p>
                            <p class="text-sm text-purple-600 font-medium">Accuracy</p>
                        </div>
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center shadow-inner">
                            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Users Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-yellow-500 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">WhatsApp Users</p>
                            <p class="text-3xl font-bold text-gray-900" id="whatsappUsers">0</p>
                            <p class="text-sm text-yellow-600 font-medium">Connected</p>
                        </div>
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center shadow-inner">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-6a2 2 0 012-2h8z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">

            <!-- Left Column: Trading Signals & Strategies -->
            <div class="xl:col-span-2 space-y-8">

                <!-- AI Trading Signals -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50 rounded-t-2xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                                    <span class="mr-2">ü§ñ</span>
                                    Latest AI Signals
                                </h3>
                                <p class="text-sm text-gray-600">Real-time trading signals powered by AI</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="loadNewsFlash()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors duration-200 shadow-md">
                                    üì∞ News Flash
                                </button>
                                <button onclick="refreshPage()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors duration-200 shadow-md">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="signalsContainer" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                <div>Loading signals...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Strategies Section -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-blue-50 rounded-t-2xl">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                <span class="mr-2">üéØ</span>
                                AI Trading Strategies
                            </h2>
                            <button onclick="refreshStrategies()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200 shadow-md">
                                Refresh Analysis
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="strategiesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-2 text-center py-8 text-gray-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                Loading strategies...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Next Day Prediction Section -->
                <div class="bg-gradient-to-r from-purple-50 via-blue-50 to-indigo-50 rounded-2xl shadow-lg p-6 border border-purple-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <span class="mr-2">üîÆ</span>
                            Next Day Market Prediction
                        </h2>
                        <div class="flex space-x-2">
                            <button onclick="generatePrediction()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-200 shadow-md">
                                Generate Prediction
                            </button>
                            <button onclick="loadNextDayPrediction()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-200 shadow-md">
                                Refresh
                            </button>
                        </div>
                    </div>

                    <div id="predictionContainer" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">üìä</div>
                            <div class="text-lg font-medium">Next-day prediction will be available after market close</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Options Chain, News & WhatsApp -->
            <div class="space-y-8">

                <!-- Options Chain -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-t-2xl">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üìà</span>
                            Options Chain
                        </h3>
                        <p class="text-sm text-gray-600">Live Nifty 50 options data</p>
                    </div>
                    <div class="p-6">
                        <div id="optionsContainer" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <div class="animate-pulse text-4xl mb-2">‚è≥</div>
                                <div>Loading options...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- News Flash -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-red-50 to-pink-50 rounded-t-2xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 flex items-center">
                                    <span class="mr-2">üì∞</span>
                                    News Flash
                                </h3>
                                <p class="text-sm text-gray-600">Breaking market news</p>
                            </div>
                            <button onclick="checkNews()" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors duration-200 shadow-md">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="newsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                <div class="animate-bounce text-4xl mb-2">üì°</div>
                                <div>Loading news...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Management -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 rounded-t-2xl">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üí¨</span>
                            WhatsApp Notifications
                        </h3>
                        <p class="text-sm text-gray-600">Manage users receiving trading alerts</p>
                    </div>
                    <div class="p-6">
                        <div class="flex space-x-2 mb-6">
                            <input type="tel" id="phoneInput" placeholder="+91XXXXXXXXXX" 
                                   class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            <button onclick="addWhatsAppUser()" 
                                    class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg focus:ring-2 focus:ring-green-500 transition-colors duration-200 shadow-md">
                                Add User
                            </button>
                        </div>
                        <div id="whatsappUsersContainer" class="space-y-2">
                            <div class="text-center py-6 text-gray-500">
                                <div class="text-3xl mb-2">üë•</div>
                                <div>Loading WhatsApp users...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics & Reports Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Performance Metrics -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-blue-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üìà</span>
                            Performance Analytics
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gradient-to-r from-green-100 to-green-50 p-4 rounded-xl">
                                    <div class="text-2xl font-bold text-green-600">87.5%</div>
                                    <div class="text-sm text-green-700">Win Rate</div>
                                </div>
                                <div class="bg-gradient-to-r from-blue-100 to-blue-50 p-4 rounded-xl">
                                    <div class="text-2xl font-bold text-blue-600">2.3:1</div>
                                    <div class="text-sm text-blue-700">Risk/Reward</div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <h4 class="font-semibold mb-3">Recent Performance</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm">Last 7 days</span>
                                        <span class="text-sm font-medium text-green-600">+12.4%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">Last 30 days</span>
                                        <span class="text-sm font-medium text-green-600">+45.2%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">Total Trades</span>
                                        <span class="text-sm font-medium">156</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade History -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üìã</span>
                            Recent Trades
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <div>
                                    <div class="font-medium">CALL 25500</div>
                                    <div class="text-sm text-gray-600">Today 2:30 PM</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-green-600">+‚Çπ2,450</div>
                                    <div class="text-sm text-green-600">+34.5%</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <div>
                                    <div class="font-medium">PUT 25400</div>
                                    <div class="text-sm text-gray-600">Yesterday 1:15 PM</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-red-600">-‚Çπ890</div>
                                    <div class="text-sm text-red-600">-12.3%</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <div>
                                    <div class="font-medium">CALL 25550</div>
                                    <div class="text-sm text-gray-600">Yesterday 11:45 AM</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-green-600">+‚Çπ1,675</div>
                                    <div class="text-sm text-green-600">+28.9%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Management Tab -->
        <div id="whatsapp-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Add Users Section -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üë•</span>
                            Add WhatsApp Users
                        </h3>
                        <p class="text-sm text-gray-600">Manage users receiving trading alerts</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="tel" id="phoneInput" placeholder="+91XXXXXXXXXX" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">User Name (Optional)</label>
                                <input type="text" id="userNameInput" placeholder="Enter user name" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notification Preferences</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-green-600 focus:ring-green-500" checked>
                                        <span class="ml-2 text-sm">High Confidence Signals (85%+)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-green-600 focus:ring-green-500" checked>
                                        <span class="ml-2 text-sm">Market Alerts</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Daily Reports</span>
                                    </label>
                                </div>
                            </div>
                            <button onclick="addWhatsAppUser()" 
                                    class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg focus:ring-2 focus:ring-green-500 transition-colors duration-200 shadow-md">
                                <span class="flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add User
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Users List -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üì±</span>
                            Active Users
                        </h3>
                        <p class="text-sm text-gray-600">Currently registered users</p>
                    </div>
                    <div class="p-6">
                        <div id="whatsappUsersContainer" class="space-y-3">
                            <div class="text-center py-6 text-gray-500">
                                <div class="text-3xl mb-2">üë•</div>
                                <div>Loading WhatsApp users...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Operations -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 lg:col-span-2">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üì¢</span>
                            Bulk Operations
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-center transition-colors duration-200">
                                <div class="text-2xl mb-2">üì®</div>
                                <div class="font-medium">Send Test Message</div>
                                <div class="text-sm text-gray-600">to all users</div>
                            </button>
                            <button class="p-4 bg-green-50 hover:bg-green-100 rounded-lg text-center transition-colors duration-200">
                                <div class="text-2xl mb-2">üìä</div>
                                <div class="font-medium">Send Daily Report</div>
                                <div class="text-sm text-gray-600">Performance summary</div>
                            </button>
                            <button class="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-center transition-colors duration-200">
                                <div class="text-2xl mb-2">üîÑ</div>
                                <div class="font-medium">Sync User List</div>
                                <div class="text-sm text-gray-600">Refresh all users</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Integration Tab -->
        <div id="api-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Zerodha Integration -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üîå</span>
                            Zerodha Kite Connect
                        </h3>
                        <p class="text-sm text-gray-600">Live market data integration</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="font-medium">Status: Official Kite MCP</span>
                                </div>
                                <span class="text-sm text-green-600">Connected via Claude Desktop</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                                <input type="password" id="zerodhaApiKey" placeholder="Enter your Zerodha API key" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                                <input type="password" id="zerodhaAccessToken" placeholder="Enter your access token" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <button onclick="testZerodhaConnection()" 
                                    class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 shadow-md">
                                Test Connection
                            </button>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">Features with Live Data:</h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>‚Ä¢ Real-time Nifty 50 prices</li>
                                    <li>‚Ä¢ Live options chain data</li>
                                    <li>‚Ä¢ Actual market volumes</li>
                                    <li>‚Ä¢ Historical data access</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Business API -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üí¨</span>
                            WhatsApp Business API
                        </h3>
                        <p class="text-sm text-gray-600">Automated notifications</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                                    <span class="font-medium">Status: Simulation Mode</span>
                                </div>
                                <span class="text-sm text-yellow-600">Not Connected</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                                <input type="password" id="whatsappAccessToken" placeholder="Enter WhatsApp Business access token" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number ID</label>
                                <input type="text" id="whatsappPhoneId" placeholder="Enter phone number ID" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <button onclick="testWhatsAppConnection()" 
                                    class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors duration-200 shadow-md">
                                Test Connection
                            </button>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2">Features with Live API:</h4>
                                <ul class="text-sm text-green-700 space-y-1">
                                    <li>‚Ä¢ Automatic signal notifications</li>
                                    <li>‚Ä¢ Market alerts and updates</li>
                                    <li>‚Ä¢ Daily performance reports</li>
                                    <li>‚Ä¢ Breaking news alerts</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claude AI Integration -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">ü§ñ</span>
                            Claude AI Integration
                        </h3>
                        <p class="text-sm text-gray-600">Enhanced market analysis</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="font-medium">Status: Fallback Analysis</span>
                                </div>
                                <span class="text-sm text-green-600">Active</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Claude API Key</label>
                                <input type="password" id="claudeApiKey" placeholder="Enter Claude API key for enhanced analysis" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <button onclick="testClaudeConnection()" 
                                    class="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors duration-200 shadow-md">
                                Test AI Connection
                            </button>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-purple-800 mb-2">AI Analysis Features:</h4>
                                <ul class="text-sm text-purple-700 space-y-1">
                                    <li>‚Ä¢ Advanced sentiment analysis</li>
                                    <li>‚Ä¢ Market pattern recognition</li>
                                    <li>‚Ä¢ News impact assessment</li>
                                    <li>‚Ä¢ Predictive modeling</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Documentation -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-slate-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üìö</span>
                            API Documentation
                        </h3>
                        <p class="text-sm text-gray-600">Setup guides and resources</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <a href="#" class="block p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200">
                                <div class="font-medium text-blue-800">Zerodha Kite Connect Setup</div>
                                <div class="text-sm text-blue-600">Step-by-step integration guide</div>
                            </a>
                            <a href="#" class="block p-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200">
                                <div class="font-medium text-green-800">WhatsApp Business API Guide</div>
                                <div class="text-sm text-green-600">How to setup automated messaging</div>
                            </a>
                            <a href="#" class="block p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors duration-200">
                                <div class="font-medium text-purple-800">Claude AI Integration</div>
                                <div class="text-sm text-purple-600">Enhance analysis with AI</div>
                            </a>
                            <a href="#" class="block p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200">
                                <div class="font-medium text-gray-800">Environment Variables</div>
                                <div class="text-sm text-gray-600">Configuration and setup</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- General Settings -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">‚öôÔ∏è</span>
                            General Settings
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Signal Generation Frequency</label>
                                <select class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option>Every 5 seconds (Current)</option>
                                    <option>Every 10 seconds</option>
                                    <option>Every 30 seconds</option>
                                    <option>Every minute</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Signal Confidence</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="confidenceSlider" min="50" max="95" value="75" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="confidenceValue" class="text-lg font-semibold text-blue-600">75%</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Only show signals above this confidence level</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Notification Preferences</label>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-blue-600 focus:ring-blue-500" checked>
                                        <span class="ml-2 text-sm">Browser notifications</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-blue-600 focus:ring-blue-500" checked>
                                        <span class="ml-2 text-sm">Sound alerts</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm">Email notifications</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Settings -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üìà</span>
                            Trading Preferences
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Default Trade Size</label>
                                <input type="number" value="1" min="1" max="10" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <p class="text-sm text-gray-500 mt-1">Number of lots per trade</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Risk Level</label>
                                <select class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option>Conservative</option>
                                    <option>Moderate (Current)</option>
                                    <option>Aggressive</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Auto-trading Features</label>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Auto-execute high confidence signals</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Auto stop-loss at 20% loss</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Auto profit booking at target</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Display Settings -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üé®</span>
                            Display Settings
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                                <select class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option>Light (Current)</option>
                                    <option>Dark</option>
                                    <option>Auto (System)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Refresh Rate</label>
                                <select class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option>Real-time (1 second)</option>
                                    <option>5 seconds</option>
                                    <option>10 seconds</option>
                                    <option>30 seconds</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Dashboard Layout</label>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="radio" name="layout" class="text-purple-600 focus:ring-purple-500" checked>
                                        <span class="ml-2 text-sm">Compact view</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="layout" class="text-purple-600 focus:ring-purple-500">
                                        <span class="ml-2 text-sm">Detailed view</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="rounded text-purple-600 focus:ring-purple-500" checked>
                                        <span class="ml-2 text-sm">Show advanced metrics</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-slate-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üíª</span>
                            System Information
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Version</span>
                                <span class="text-sm font-medium">NIFINOVA v2.0.1</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Last Updated</span>
                                <span class="text-sm font-medium">June 26, 2025</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Uptime</span>
                                <span class="text-sm font-medium">2h 34m</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Developer</span>
                                <span class="text-sm font-medium">PKR SOLUTION</span>
                            </div>
                            <hr class="my-4">
                            <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200">
                                Check for Updates
                            </button>
                            <button class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors duration-200">
                                Export Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolio-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Portfolio Overview -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-gray-200">
                    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="mr-2">üíº</span>
                            Portfolio Overview
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="text-center p-4 bg-green-50 rounded-xl">
                                <div class="text-3xl font-bold text-green-600">‚Çπ24,567</div>
                                <div class="text-sm text-green-700">Total P&L</div>
                                <div class="text-xs text-green-600">+18.5% overall</div>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                <div class="text-3xl font-bold text-blue-600">‚Çπ8,450</div>
                                <div class="text-sm text-blue-700">Today's P&L</div>
                                <div class="text-xs text-blue-600">+3.2% today</div>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-xl">
                                <div class="text-3xl font-bold text-purple-600">156</div>
                                <div class="text-sm text-purple-700">Total Trades</div>
                                <div class="text-xs text-purple-600">87.5% win rate</div>
                            </div>
                        </div>
                        
                        <!-- Active Positions -->
                        <h4 class="font-semibold text-gray-800 mb-4">Active Positions</h4>
                        <div id="activeTradesContainer" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-2">üìä</div>
                                <div>Loading active positions...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                        <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-t-2xl">
                            <h3 class="text-lg font-bold text-gray-900 flex items-center">
                                <span class="mr-2">‚ö°</span>
                                Quick Actions
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <button class="w-full p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-left transition-colors duration-200">
                                    <div class="font-medium text-blue-800">Exit All Positions</div>
                                    <div class="text-sm text-blue-600">Close all active trades</div>
                                </button>
                                <button class="w-full p-3 bg-green-50 hover:bg-green-100 rounded-lg text-left transition-colors duration-200">
                                    <div class="font-medium text-green-800">Book Profits</div>
                                    <div class="text-sm text-green-600">Exit profitable positions</div>
                                </button>
                                <button class="w-full p-3 bg-purple-50 hover:bg-purple-100 rounded-lg text-left transition-colors duration-200">
                                    <div class="font-medium text-purple-800">Download Report</div>
                                    <div class="text-sm text-purple-600">Export trading history</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                        <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-red-50 to-pink-50 rounded-t-2xl">
                            <h3 class="text-lg font-bold text-gray-900 flex items-center">
                                <span class="mr-2">üõ°Ô∏è</span>
                                Risk Management
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Daily Loss Limit</span>
                                        <span>‚Çπ2,500 / ‚Çπ5,000</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-yellow-500 h-2 rounded-full" style="width: 50%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Max Open Positions</span>
                                        <span>3 / 5</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 60%"></div>
                                    </div>
                                </div>
                                <div class="text-center pt-3">
                                    <div class="text-2xl">üü¢</div>
                                    <div class="text-sm font-medium text-green-600">Risk Under Control</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    let isConnected = false;

    // Socket connection
    socket.on('connect', function() {
        console.log('Connected to real-time updates');
        isConnected = true;
        updateConnectionStatus(true);
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
        isConnected = false;
        updateConnectionStatus(false);
    });

    socket.on('market_update', function(data) {
        console.log('Market update received:', data);
        if (data.nifty_data) updateNiftyData(data.nifty_data);
        if (data.new_signals) updateSignals(data.new_signals);
        if (data.options_chain) updateOptionsChain(data.options_chain);
    });

    socket.on('news_flash', function(data) {
        console.log('News flash received:', data);
        showNewsFlash(data.news);
        loadNewsFlash();
    });

    socket.on('next_day_prediction', function(data) {
        console.log('Next-day prediction received:', data);
        loadNextDayPrediction();
    });

    function updateConnectionStatus(connected) {
        const statusDot = document.getElementById('statusDot');
        if (connected) {
            statusDot.className = 'w-3 h-3 rounded-full mr-2 bg-green-500 animate-pulse';
        } else {
            statusDot.className = 'w-3 h-3 rounded-full mr-2 bg-red-500 animate-pulse';
        }
    }

    function updateMarketStatus(status) {
        const statusElement = document.getElementById('marketStatus');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        let bgClass = 'bg-gray-100 text-gray-800 border-gray-300';
        let dotClass = 'w-3 h-3 rounded-full mr-2 bg-gray-500 animate-pulse';

        switch(status) {
            case 'OPEN':
                bgClass = 'bg-green-100 text-green-800 border-green-300';
                dotClass = 'w-3 h-3 rounded-full mr-2 bg-green-500 animate-pulse';
                statusText.textContent = 'Market Open';
                break;
            case 'CLOSED':
                bgClass = 'bg-red-100 text-red-800 border-red-300';
                dotClass = 'w-3 h-3 rounded-full mr-2 bg-red-500 animate-pulse';
                statusText.textContent = 'Market Closed';
                break;
            case 'PRE_MARKET':
                bgClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
                dotClass = 'w-3 h-3 rounded-full mr-2 bg-yellow-500 animate-pulse';
                statusText.textContent = 'Pre-Market';
                break;
            case 'WEEKEND':
                bgClass = 'bg-blue-100 text-blue-800 border-blue-300';
                dotClass = 'w-3 h-3 rounded-full mr-2 bg-blue-500 animate-pulse';
                statusText.textContent = 'Weekend';
                break;
        }

        statusElement.className = `px-4 py-2 rounded-full text-sm font-medium border-2 transition-all duration-300 ${bgClass}`;
        statusDot.className = dotClass;
    }

    function updateNiftyData(data) {
        document.getElementById('niftyPrice').textContent = `‚Çπ${data.price.toFixed(2)}`;

        const changeElement = document.getElementById('niftyChange');
        const changeColor = data.change >= 0 ? 'text-green-600' : 'text-red-600';
        const changeSign = data.change >= 0 ? '+' : '';
        changeElement.textContent = `${changeSign}${data.change.toFixed(2)} (${changeSign}${data.change_percent.toFixed(2)}%)`;
        changeElement.className = `text-sm font-medium ${changeColor}`;

        document.getElementById('niftyVolume').textContent = data.volume.toLocaleString();
        document.getElementById('lastUpdated').textContent = new Date(data.last_updated).toLocaleTimeString();

        updateMarketStatus(data.market_status);
        updateSentiment(data.sentiment);
        updateFlashMessage(data.flash_message);
    }

    function updateSentiment(sentiment) {
        const sentimentBadge = document.getElementById('sentimentBadge');
        let badgeClass = 'bg-gray-100 text-gray-800';

        switch(sentiment) {
            case 'BULLISH':
                badgeClass = 'bg-green-100 text-green-800';
                break;
            case 'BEARISH':
                badgeClass = 'bg-red-100 text-red-800';
                break;
            case 'NEUTRAL':
                badgeClass = 'bg-gray-100 text-gray-800';
                break;
        }

        sentimentBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${badgeClass}`;
        sentimentBadge.textContent = sentiment;
    }

    function updateFlashMessage(message) {
        const flashBanner = document.getElementById('flashBanner');
        const flashMessage = document.getElementById('flashMessage');

        if (message && message.trim() !== '') {
            flashMessage.textContent = message;
            flashBanner.classList.remove('hidden');

            setTimeout(() => {
                flashBanner.classList.add('hidden');
            }, 5000);
        }
    }

    function updateSignals(newSignals) {
        if (newSignals && newSignals.length > 0) {
            loadSignals();
        }
    }

    function updateOptionsChain(data) {
        const container = document.getElementById('optionsContainer');
        const options = data.options || data;
        const marketStatus = data.market_status || 'UNKNOWN';
        const dataAvailable = data.data_available !== undefined ? data.data_available : (options && options.length > 0);
        const message = data.message || '';

        if (!dataAvailable || !options || options.length === 0) {
            const statusMessage = marketStatus !== 'OPEN' 
                ? `Market is ${marketStatus.replace('_', ' ').toLowerCase()} - No real options data available`
                : 'No options data available';

            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">‚è∞</div>
                    <div class="text-gray-500 mb-2">${statusMessage}</div>
                    ${message ? `<div class="text-sm text-gray-400">${message}</div>` : ''}
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg text-blue-700 text-sm">
                        <i class="fas fa-info-circle mr-2"></i>
                        Real-time options data will be shown when market is live
                    </div>
                </div>
            `;
            return;
        }

        const html = `
            <div class="mb-3 flex justify-between items-center">
                <span class="text-sm text-green-600 font-medium flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                    Live Options Data
                </span>
                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Market: ${marketStatus.replace('_', ' ')}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-xs uppercase">
                            <th class="px-3 py-3 text-left font-semibold">Call LTP</th>
                            <th class="px-3 py-3 text-left font-semibold">Call Vol</th>
                            <th class="px-3 py-3 text-center font-bold bg-yellow-100">Strike</th>
                            <th class="px-3 py-3 text-right font-semibold">Put Vol</th>
                            <th class="px-3 py-3 text-right font-semibold">Put LTP</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${options.map(option => `
                            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200">
                                <td class="px-3 py-3 text-green-600 font-medium">‚Çπ${option.call_ltp.toFixed(2)}</td>
                                <td class="px-3 py-3 text-gray-600">${option.call_volume.toLocaleString()}</td>
                                <td class="px-3 py-3 text-center font-bold bg-yellow-50 border-l border-r border-yellow-200">${option.strike_price}</td>
                                <td class="px-3 py-3 text-right text-gray-600">${option.put_volume.toLocaleString()}</td>
                                <td class="px-3 py-3 text-right text-red-600 font-medium">‚Çπ${option.put_ltp.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    }

    function loadMarketOverview() {
        fetch('/api/market/overview')
            .then(response => response.json())
            .then(data => {
                updateNiftyData(data.nifty50);
                document.getElementById('activeSignals').textContent = data.active_signals;
                document.getElementById('successRate').textContent = `${data.success_rate}%`;
                document.getElementById('whatsappUsers').textContent = data.whatsapp_users;
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    }

    function loadSignals() {
        fetch('/api/signals')
            .then(response => response.json())
            .then(signals => {
                const container = document.getElementById('signalsContainer');

                if (signals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">üì°</div>
                            <div class="text-lg font-medium">No signals available</div>
                            <div class="text-sm">Waiting for market opportunities...</div>
                        </div>
                    `;
                    return;
                }

                const html = signals.slice(0, 10).map(signal => `
                    <div class="border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300 ${signal.type === 'CALL' ? 'hover:border-green-300 bg-gradient-to-r from-green-50 to-emerald-50' : 'hover:border-red-300 bg-gradient-to-r from-red-50 to-rose-50'}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 text-sm font-bold text-white rounded-full shadow-lg ${signal.type === 'CALL' ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-red-500 to-red-600'}">
                                    ${signal.type}
                                </span>
                                <span class="text-xl font-bold text-gray-900">‚Çπ${signal.strike_price}</span>
                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                    ${signal.strategy_type}
                                </span>
                            </div>
                            <span class="px-3 py-1 text-sm font-bold rounded-full ${signal.confidence >= 80 ? 'bg-green-100 text-green-800' : signal.confidence >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${signal.confidence}% Confidence
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <span class="text-gray-600 block">Target Price</span>
                                <span class="font-bold text-green-600 text-lg">‚Çπ${signal.target_price}</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <span class="text-gray-600 block">Stop Loss</span>
                                <span class="font-bold text-red-600 text-lg">‚Çπ${signal.stop_loss}</span>
                            </div>
                        </div>

                        <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                            <p class="text-sm text-gray-700 font-medium mb-1">Technical Analysis:</p>
                            <p class="text-sm text-gray-600">${signal.reasoning}</p>
                        </div>

                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span class="bg-gray-100 px-2 py-1 rounded-full">Expiry: ${signal.expiry_date}</span>
                            <span class="bg-gray-100 px-2 py-1 rounded-full">${signal.holding_period}</span>
                            <span class="bg-gray-100 px-2 py-1 rounded-full">${new Date(signal.created_at).toLocaleTimeString()}</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading signals:', error);
                document.getElementById('signalsContainer').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <div>Error loading signals</div>
                    </div>
                `;
            });
    }

    function loadOptionsChain() {
        fetch('/api/options-chain')
            .then(response => response.json())
            .then(options => {
                updateOptionsChain(options);
            })
            .catch(error => {
                console.error('Error loading options chain:', error);
            });
    }

    function loadWhatsAppUsers() {
        fetch('/api/whatsapp/users')
            .then(response => response.json())
            .then(users => {
                const container = document.getElementById('whatsappUsersContainer');

                if (users.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <div class="text-3xl mb-2">üë•</div>
                            <div>No WhatsApp users registered</div>
                        </div>
                    `;
                    return;
                }

                const html = users.map(user => `
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <span class="text-green-600 text-sm">üì±</span>
                            </div>
                            <span class="font-medium">${user.phone_number}</span>
                        </div>
                        <button onclick="removeWhatsAppUser('${user.phone_number}')" 
                                class="text-red-600 hover:text-red-800 text-sm bg-red-50 hover:bg-red-100 px-3 py-1 rounded-lg transition-colors duration-200">
                            Remove
                        </button>
                    </div>
                `).join('');

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading WhatsApp users:', error);
            });
    }

    function addWhatsAppUser() {
        const phoneInput = document.getElementById('phoneInput');
        const phoneNumber = phoneInput.value.trim();

        if (!phoneNumber) {
            alert('Please enter a phone number');
            return;
        }

        fetch('/api/whatsapp/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({phone_number: phoneNumber})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                phoneInput.value = '';
                loadWhatsAppUsers();
                loadMarketOverview();
            }
        })
        .catch(error => {
            console.error('Error adding user:', error);
            alert('Error adding user');
        });
    }

    function removeWhatsAppUser(phoneNumber) {
        if (!confirm('Remove this user from WhatsApp notifications?')) {
            return;
        }

        fetch(`/api/whatsapp/users/${encodeURIComponent(phoneNumber)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadWhatsAppUsers();
                loadMarketOverview();
            } else {
                alert('Error removing user');
            }
        })
        .catch(error => {
            console.error('Error removing user:', error);
            alert('Error removing user');
        });
    }

    function showNewsFlash(news) {
        const flashBar = document.getElementById('newsFlashBar');
        const flashText = document.getElementById('newsFlashText');

        const impactEmoji = news.impact === 'HIGH' ? 'üö®' : news.impact === 'MEDIUM' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        const sentimentEmoji = news.sentiment === 'POSITIVE' ? 'üìà' : news.sentiment === 'NEGATIVE' ? 'üìâ' : 'üìä';

        flashText.innerHTML = `${impactEmoji} ${sentimentEmoji} ${news.headline} - ${news.market_reaction}`;
        flashBar.classList.remove('hidden');

        const hideTime = news.impact === 'HIGH' ? 30000 : 15000;
        setTimeout(() => {
            flashBar.classList.add('hidden');
        }, hideTime);
    }

    function hideNewsFlash() {
        document.getElementById('newsFlashBar').classList.add('hidden');
    }

    function loadNewsFlash() {
        fetch('/api/news/flash')
            .then(response => response.json())
            .then(news => {
                const container = document.getElementById('newsContainer');
                if (news.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üì∞</div>
                            <div>No recent news flashes</div>
                        </div>
                    `;
                    return;
                }

                const html = news.slice(0, 10).map(item => {
                    const impactColor = item.impact === 'HIGH' ? 'text-red-600 bg-red-50' : item.impact === 'MEDIUM' ? 'text-yellow-600 bg-yellow-50' : 'text-blue-600 bg-blue-50';
                    const sentimentColor = item.sentiment === 'POSITIVE' ? 'text-green-600' : item.sentiment === 'NEGATIVE' ? 'text-red-600' : 'text-gray-600';
                    const categoryEmoji = {
                        'WAR': '‚öîÔ∏è',
                        'ECONOMY': 'üí∞',
                        'POLITICS': 'üèõÔ∏è',
                        'CORPORATE': 'üè¢',
                        'GLOBAL': 'üåç',
                        'GENERAL': 'üì∞'
                    }[item.category] || 'üì∞';

                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200 hover:shadow-md">
                            <div class="flex items-start justify-between mb-3">
                                <span class="px-3 py-1 text-xs font-medium rounded-full ${impactColor}">
                                    ${item.impact} IMPACT
                                </span>
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${new Date(item.timestamp).toLocaleTimeString()}</span>
                            </div>

                            <div class="flex items-center space-x-2 mb-3">
                                <span class="text-xl">${categoryEmoji}</span>
                                <span class="text-xs font-medium text-gray-600 bg-gray-100 px-2 py-1 rounded-full">${item.category}</span>
                                <span class="text-xs ${sentimentColor} font-medium">${item.sentiment}</span>
                            </div>

                            <h4 class="text-sm font-semibold text-gray-900 mb-2">${item.headline}</h4>
                            <p class="text-xs text-gray-600 mb-3 bg-gray-50 p-2 rounded">${item.market_reaction}</p>

                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">${item.source}</span>
                                <a href="${item.url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded transition-colors duration-200">
                                    Read more ‚Üí
                                </a>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading news:', error);
                document.getElementById('newsContainer').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <div>Error loading news</div>
                    </div>
                `;
            });
    }

    function checkNews() {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Checking...';

        fetch('/api/news/check')
            .then(response => response.json())
            .then(data => {
                console.log(`Found ${data.new_flashes} new flashes`);
                loadNewsFlash();
                if (data.new_flashes > 0) {
                    alert(`Found ${data.new_flashes} new breaking news!`);
                }
            })
            .catch(error => {
                console.error('Error checking news:', error);
                alert('Error checking news');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
    }

    function loadTradingStrategies() {
        fetch('/api/trading/strategies')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('strategiesContainer');
                const strategies = data.strategies || [];

                if (strategies.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-2 text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìä</div>
                            <div>No strategy analysis available</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = strategies.map(strategy => {
                    const strategyEmoji = {
                        'SCALPING': '‚ö°',
                        'INTRADAY': 'üìà',
                        'BTST': 'üåô',
                        'POSITIONAL': 'üìä'
                    }[strategy.strategy_type] || 'üìà';

                    const riskColor = {
                        'LOW': 'green',
                        'MEDIUM': 'yellow',
                        'HIGH': 'red'
                    }[strategy.risk_level] || 'gray';

                    const bgColor = strategy.recommended ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200' : 'bg-gradient-to-r from-gray-50 to-slate-50 border-gray-200';
                    const textColor = strategy.recommended ? 'text-green-800' : 'text-gray-600';

                    return `
                        <div class="border-2 ${bgColor} rounded-xl p-4 ${textColor} hover:shadow-lg transition-shadow duration-300">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">${strategyEmoji}</span>
                                    <h3 class="font-bold text-sm">${strategy.strategy_type}</h3>
                                </div>
                                <span class="text-xs bg-${riskColor}-100 text-${riskColor}-800 px-3 py-1 rounded-full font-medium">
                                    ${strategy.risk_level}
                                </span>
                            </div>

                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-medium">Confidence</span>
                                    <span class="text-xs font-bold">${strategy.confidence}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: ${strategy.confidence}%"></div>
                                </div>
                            </div>

                            <div class="text-xs mb-3 space-y-1">
                                <div><strong>Duration:</strong> ${strategy.target_duration}</div>
                                <div><strong>Capital:</strong> ${strategy.capital_allocation}</div>
                            </div>

                            <div class="text-xs mb-4 bg-white p-2 rounded-lg">
                                <strong>Analysis:</strong> ${strategy.reasoning}
                            </div>

                            <div class="text-center">
                                ${strategy.recommended 
                                    ? '<span class="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-medium">‚úÖ RECOMMENDED</span>'
                                    : '<span class="text-xs bg-gray-400 text-white px-3 py-1 rounded-full font-medium">‚è∏Ô∏è WAIT</span>'
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                document.getElementById('strategiesContainer').innerHTML = `
                    <div class="col-span-2 text-center py-8 text-red-500">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <div>Error loading strategies</div>
                    </div>
                `;
            });
    }

    function refreshStrategies() {
        loadTradingStrategies();
    }

    function loadNextDayPrediction() {
        fetch('/api/prediction/next-day')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('predictionContainer');

                if (!data.available) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">üìä</div>
                            <div class="text-lg font-medium">${data.message}</div>
                            <div class="text-sm mt-2 bg-blue-50 text-blue-700 p-3 rounded-lg">
                                Market Status: ${data.market_status.replace('_', ' ')}
                            </div>
                        </div>
                    `;
                    return;
                }

                const prediction = data.prediction;
                const directionColor = prediction.direction === 'BULLISH' ? 'text-green-600' : prediction.direction === 'BEARISH' ? 'text-red-600' : 'text-gray-600';
                const directionBg = prediction.direction === 'BULLISH' ? 'bg-green-100' : prediction.direction === 'BEARISH' ? 'bg-red-100' : 'bg-gray-100';
                const confidenceColor = prediction.confidence > 80 ? 'text-green-600' : prediction.confidence > 60 ? 'text-yellow-600' : 'text-red-600';

                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl p-6 shadow-lg border-2 ${directionBg.replace('bg-', 'border-')}">
                                <div class="text-center mb-6">
                                    <div class="text-5xl mb-3">
                                        ${prediction.direction === 'BULLISH' ? 'üöÄ' : prediction.direction === 'BEARISH' ? 'üìâ' : '‚ÜîÔ∏è'}
                                    </div>
                                    <h3 class="text-2xl font-bold ${directionColor}">${prediction.direction}</h3>
                                    <p class="text-sm text-gray-600">for ${prediction.prediction_date}</p>
                                </div>

                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-600 font-medium">Confidence:</span>
                                        <span class="font-bold ${confidenceColor} text-lg">${prediction.confidence}%</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-600 font-medium">Probability Up:</span>
                                        <span class="font-bold text-lg">${prediction.probability_up}%</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-600 font-medium">Market Regime:</span>
                                        <span class="font-bold text-lg">${prediction.market_regime}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-600 font-medium">Volatility:</span>
                                        <span class="font-bold text-lg">${prediction.volatility_outlook}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-white rounded-xl p-4 shadow-lg border border-gray-200">
                                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                        <span class="mr-2">üíπ</span>
                                        Price Targets
                                    </h4>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between p-2 bg-green-50 rounded">
                                            <span>Expected High:</span>
                                            <span class="font-bold text-green-600">‚Çπ${prediction.price_targets.high}</span>
                                        </div>
                                        <div class="flex justify-between p-2 bg-red-50 rounded">
                                            <span>Expected Low:</span>
                                            <span class="font-bold text-red-600">‚Çπ${prediction.price_targets.low}</span>
                                        </div>
                                        <div class="flex justify-between p-2 bg-blue-50 rounded">
                                            <span>Range:</span>
                                            <span class="font-bold text-blue-600">‚Çπ${prediction.price_targets.expected_range}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl p-4 shadow-lg border border-gray-200">
                                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                        <span class="mr-2">üîç</span>
                                        Key Drivers
                                    </h4>
                                    <div class="space-y-2 text-sm">
                                        ${prediction.key_drivers.map(driver => `
                                            <div class="p-2 bg-gray-50 rounded text-gray-700">‚Ä¢ ${driver}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl p-4 shadow-lg border border-gray-200">
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <span class="mr-2">üìã</span>
                                    Trading Recommendations
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${prediction.trading_recommendations.map(rec => {
                                        const riskColor = rec.risk_level === 'LOW' ? 'text-green-600 bg-green-50' : rec.risk_level === 'HIGH' ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50';
                                        return `
                                            <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow duration-200">
                                                <div class="font-medium text-gray-800 mb-2">${rec.strategy}</div>
                                                <div class="text-sm text-gray-600 mb-3">${rec.reasoning}</div>
                                                <div class="flex justify-between text-xs">
                                                    <span class="${riskColor} px-2 py-1 rounded-full font-medium">${rec.risk_level} Risk</span>
                                                    <span class="font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${rec.allocation}</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            ${prediction.risk_factors && prediction.risk_factors.length > 0 ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mt-4">
                                    <h4 class="font-bold text-yellow-800 mb-3 flex items-center">
                                        <span class="mr-2">‚ö†Ô∏è</span>
                                        Risk Factors
                                    </h4>
                                    <div class="space-y-1 text-sm text-yellow-700">
                                        ${prediction.risk_factors.map(risk => `<div class="p-2 bg-yellow-100 rounded">‚Ä¢ ${risk}</div>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading prediction:', error);
                document.getElementById('predictionContainer').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <div>Error loading prediction</div>
                    </div>
                `;
            });
    }

    function generatePrediction() {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'Generating...';

        fetch('/api/prediction/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNextDayPrediction();
            } else {
                alert('Error generating prediction: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error generating prediction:', error);
            alert('Error generating prediction');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = 'Generate Prediction';
        });
    }

    function refreshPage() {
        location.reload();
    }

    function logout() {
        fetch('/logout', {
            method: 'POST'
        })
        .then(() => {
            window.location.href = '/login';
        })
        .catch(error => {
            console.error('Logout error:', error);
            window.location.href = '/login';
        });
    }

function updatePrediction(prediction) {
            const predictionCard = document.getElementById('prediction-card');
            if (predictionCard && prediction) {
                const directionColor = prediction.direction === 'UP' ? 'text-green-600' : 
                                     prediction.direction === 'DOWN' ? 'text-red-600' : 'text-yellow-600';

                predictionCard.innerHTML = `
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2">Next Day Prediction</h3>
                        <div class="space-y-2">
                            <p><span class="font-semibold">Direction:</span> <span class="${directionColor}">${prediction.direction}</span></p>
                            <p><span class="font-semibold">Confidence:</span> ${prediction.confidence}%</p>
                            <p><span class="font-semibold">Expected Range:</span> ${prediction.price_targets.low} - ${prediction.price_targets.high}</p>
                            <p><span class="font-semibold">Market Regime:</span> ${prediction.market_regime}</p>
                        </div>
                    </div>
                `;
            }
        }

        function updateOptionsChain(optionsData) {
            const optionsTable = document.getElementById('options-table');
            if (optionsTable && optionsData && optionsData.length > 0) {
                const tbody = optionsTable.querySelector('tbody');
                tbody.innerHTML = '';

                optionsData.slice(0, 10).forEach(option => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-4 py-2">${option.strike}</td>
                        <td class="px-4 py-2 text-green-600">‚Çπ${option.call_ltp || 'N/A'}</td>
                        <td class="px-4 py-2">${option.call_volume || 0}</td>
                        <td class="px-4 py-2 text-red-600">‚Çπ${option.put_ltp || 'N/A'}</td>
                        <td class="px-4 py-2">${option.put_volume || 0}</td>
                    `;
                });
            }
        }

        // News flash functionality
        function checkNews() {
            fetch('/api/news/check')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        showNewsFlash(data[0]);
                    }
                })
                .catch(error => {
                    console.error('Error checking news:', error);
                });
        }

        function showNewsFlash(news) {
            const flashDiv = document.getElementById('newsFlash');
            if (flashDiv && news) {
                flashDiv.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${news.impact === 'HIGH' ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div>
                                <h3 class="font-bold text-red-800">${news.headline}</h3>
                                <p class="text-red-600">${news.summary}</p>
                                <p class="text-sm text-red-500">Impact: ${news.impact} | ${new Date(news.timestamp).toLocaleTimeString()}</p>
                            </div>
                        </div>
                    </div>
                `;
                flashDiv.style.display = 'block';

                // Auto-hide after 10 seconds
                setTimeout(() => {
                    flashDiv.style.display = 'none';
                }, 10000);
            }
        }

        // Auto-refresh news every 30 seconds
        setInterval(checkNews, 30000);

// Refresh functionality
        function refreshData() {
            loadMarketData();
            loadSignals();
            loadTradingStrategies();
            loadNewsFlash();
            loadOptionsChain();
            loadNextDayPrediction();
            checkNews();
        }
// Load functions
        function loadMarketData() {
            fetch('/api/market/overview')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading data:', data.error);
                        return;
                    }
                    updateNiftyData(data.nifty50);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        function loadPrediction() {
            fetch('/api/prediction/next-day')
                .then(response => response.json())
                .then(data => {
                    if (data && data.prediction) {
                        updatePrediction(data.prediction);
                    }
                })
                .catch(error => {
                    console.error('Error loading prediction:', error);
                });
        }

        function loadOptionsChain() {
            fetch('/api/options-chain')
                .then(response => response.json())
                .then(data => {
                    updateOptionsChain(data.options);
                })
                .catch(error => {
                    console.error('Error loading options chain:', error);
                });
        }


        // Tab Management
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                selectedTab.classList.add('active');
            }

            // Activate selected tab button
            const selectedButton = document.getElementById(`tab-${tabName}`);
            if (selectedButton) {
                selectedButton.classList.add('active', 'border-blue-500', 'text-blue-600');
                selectedButton.classList.remove('border-transparent', 'text-gray-500');
            }

            // Load tab-specific content
            switch(tabName) {
                case 'trading':
                    loadMarketOverview();
                    loadSignals();
                    loadOptionsChain();
                    loadTradingStrategies();
                    loadNextDayPrediction();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
                case 'whatsapp':
                    loadWhatsAppUsers();
                    loadWhatsAppStats();
                    break;
                case 'api':
                    loadApiIntegrationStatus();
                    break;
                case 'settings':
                    loadUserSettings();
                    break;
                case 'portfolio':
                    loadActiveTrades();
                    loadPortfolioStats();
                    break;
            }
        }

        // API Integration Functions
        function testZerodhaConnection() {
            const apiKey = document.getElementById('zerodhaApiKey').value;
            const accessToken = document.getElementById('zerodhaAccessToken').value;
            
            if (!apiKey || !accessToken) {
                alert('Please enter both API key and access token');
                return;
            }
            
            // Simulate API test
            alert('Testing Zerodha connection... This would validate your credentials in a real implementation.');
        }

        function testWhatsAppConnection() {
            const accessToken = document.getElementById('whatsappAccessToken').value;
            const phoneId = document.getElementById('whatsappPhoneId').value;
            
            if (!accessToken || !phoneId) {
                alert('Please enter both access token and phone number ID');
                return;
            }
            
            // Simulate API test
            alert('Testing WhatsApp connection... This would validate your credentials in a real implementation.');
        }

        function testClaudeConnection() {
            const apiKey = document.getElementById('claudeApiKey').value;
            
            if (!apiKey) {
                alert('Please enter Claude API key');
                return;
            }
            
            // Simulate API test
            alert('Testing Claude AI connection... This would validate your API key in a real implementation.');
        }

        // Settings Functions
        function loadSettings() {
            const slider = document.getElementById('confidenceSlider');
            const valueDisplay = document.getElementById('confidenceValue');
            
            if (slider && valueDisplay) {
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value + '%';
                });
            }
        }

        function loadAnalyticsData() {
            // Load performance metrics
            fetch('/api/analytics/performance')
                .then(response => response.json())
                .then(data => {
                    updateAnalyticsDisplay(data);
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                    showAnalyticsError();
                });
        }

        function updateAnalyticsDisplay(data) {
            // Update analytics display with real data
            console.log('Analytics data loaded:', data);
            
            // Show actual analytics content
            const analyticsContainer = document.querySelector('#analytics-tab');
            if (analyticsContainer) {
                // Analytics data is already in the HTML, just ensure it's visible
                analyticsContainer.innerHTML = analyticsContainer.innerHTML;
            }
        }

        function showAnalyticsError() {
            const analyticsContainer = document.querySelector('#analytics-tab');
            if (analyticsContainer) {
                analyticsContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìä</div>
                        <div class="text-lg font-medium text-gray-600">Analytics data loading...</div>
                        <div class="text-sm text-gray-500 mt-2">Performance metrics will be shown here</div>
                    </div>
                `;
            }
        }

        function loadApiIntegrationStatus() {
            fetch('/api/mcp/status')
                .then(response => response.json())
                .then(data => {
                    updateApiStatus(data);
                })
                .catch(error => {
                    console.error('Error loading API status:', error);
                    showApiStatusError();
                });
        }

        function updateApiStatus(data) {
            console.log('API status loaded:', data);
            
            // Update Zerodha status
            const zerodhaStatus = document.querySelector('#zerodha-status');
            if (zerodhaStatus) {
                zerodhaStatus.innerHTML = data.kite_mcp_enabled ? 
                    '<span class="text-green-600">‚úÖ Connected</span>' : 
                    '<span class="text-yellow-600">‚ö†Ô∏è Not Connected</span>';
            }
            
            // Update WhatsApp status
            const whatsappStatus = document.querySelector('#whatsapp-status');
            if (whatsappStatus) {
                whatsappStatus.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è Simulation Mode</span>';
            }
            
            // Update Claude status
            const claudeStatus = document.querySelector('#claude-status');
            if (claudeStatus) {
                claudeStatus.innerHTML = data.claude_desktop_ready ? 
                    '<span class="text-green-600">‚úÖ Ready</span>' : 
                    '<span class="text-green-600">‚úÖ Fallback Active</span>';
            }
        }

        function showApiStatusError() {
            console.log('API status error - showing default status');
        }

        function loadWhatsAppStats() {
            // Load WhatsApp user statistics
            fetch('/api/whatsapp/stats')
                .then(response => response.json())
                .then(data => {
                    updateWhatsAppStats(data);
                })
                .catch(error => {
                    console.log('WhatsApp stats loaded from existing data');
                });
        }

        function updateWhatsAppStats(data) {
            console.log('WhatsApp stats:', data);
        }

        function loadUserSettings() {
            // Load user preferences
            const slider = document.getElementById('confidenceSlider');
            const valueDisplay = document.getElementById('confidenceValue');
            
            if (slider && valueDisplay) {
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value + '%';
                });
            }
            
            console.log('Settings loaded');
        }

        function loadPortfolioStats() {
            // Load portfolio statistics
            fetch('/api/portfolio/stats')
                .then(response => response.json())
                .then(data => {
                    updatePortfolioStats(data);
                })
                .catch(error => {
                    console.log('Portfolio stats loaded from default data');
                });
        }

        function updatePortfolioStats(data) {
            console.log('Portfolio stats:', data);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with trading tab
            switchTab('trading');
            
            // Load initial data
            loadMarketOverview();
            loadSignals();
            loadOptionsChain();
            loadWhatsAppUsers();
            loadNewsFlash();
            loadTradingStrategies();
            loadNextDayPrediction();
            loadActiveTrades();
        });

    // Refresh data periodically
    setInterval(loadMarketOverview, 30000);
    setInterval(loadSignals, 60000);
    setInterval(loadWhatsAppUsers, 300000);
    setInterval(loadNewsFlash, 120000);
    setInterval(loadTradingStrategies, 45000);
    setInterval(loadNextDayPrediction, 600000);

// Socket event handlers (prevent redeclaration)
        if (typeof socket !== 'undefined') {
            socket.on('connected', function(data) {
                console.log('Connected to real-time updates');
                loadActiveTrades(); // Load active trades on connection
            });
        }

        socket.on('market_update', function(data) {
            console.log('Market update received:', data);
            updateNiftyData(data.nifty_data);
            updateSignals(data.new_signals);
            updateOptionsChain(data.options_chain);
            loadActiveTrades(); // Refresh active trades
        });

        socket.on('trade_alert', function(data) {
            console.log('Trade alert received:', data);

            // Show browser notification if supported
            if (Notification.permission === 'granted') {
                new Notification('NIFINOVA Trade Alert', {
                    body: data.alert + ` - P&L: ${data.pnl_percent > 0 ? '+' : ''}${data.pnl_percent.toFixed(1)}%`,
                    icon: '/favicon.ico'
                });
            }

            // Update active trades display
            loadActiveTrades();

            // Show alert popup
            showTradeAlert(data);
        });

        function showTradeAlert(alertData) {
            const alertType = alertData.alert;
            let message = '';
            let bgColor = 'bg-blue-500';

            switch(alertType) {
                case 'TARGET_HIT':
                    message = 'üéØ TARGET HIT! Consider booking profits!';
                    bgColor = 'bg-green-500';
                    break;
                case 'STOP_LOSS_HIT':
                    message = 'üõë STOP LOSS HIT! Exit recommended!';
                    bgColor = 'bg-red-500';
                    break;
                case 'PROFIT_50':
                    message = 'üöÄ EXCELLENT! 50%+ profit achieved!';
                    bgColor = 'bg-green-500';
                    break;
                case 'LOSS_20':
                    message = '‚ö†Ô∏è CAUTION! 20% loss reached!';
                    bgColor = 'bg-red-500';
                    break;
                default:
                    message = 'üìä Trade Update';
            }

            // Create alert div
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50 max-w-sm`;
            alertDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold">Trade #${alertData.trade_id}</div>
                        <div class="text-sm">${message}</div>
                        <div class="text-xs mt-1">
                            Current LTP: ‚Çπ${alertData.current_ltp.toFixed(2)}<br>
                            P&L: ${alertData.pnl_percent > 0 ? '+' : ''}${alertData.pnl_percent.toFixed(1)}%
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        ‚úï
                    </button>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Auto remove after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 10000);
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

function updateSignals(signals) {
            const container = document.getElementById('signalsContainer');

            // Filter for high-probability signals only
            const highProbSignals = signals.filter(s => s.win_probability >= 75);

            if (!highProbSignals || highProbSignals.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üîç</div>
                        <p>Analyzing market conditions...</p>
                        <p class="text-sm">Only showing signals with 75%+ win probability</p>
                        <div class="mt-4 text-xs">
                            <div class="bg-blue-100 p-3 rounded">
                                <strong>Quality over Quantity:</strong> We only show signals with high probability of success.
                                This ensures better trading outcomes.
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = highProbSignals.map(signal => `
                <div class="signal-card p-4 border rounded-lg ${signal.type === 'CALL' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="signal-type ${signal.type === 'CALL' ? 'bg-green-500' : 'bg-red-500'}">${signal.type}</span>
                            <span class="font-semibold text-lg">‚Çπ${signal.strike_price}</span>
                            <span class="probability-badge bg-purple-500 text-white px-2 py-1 rounded text-xs font-bold">
                                ${signal.win_probability || 0}% WIN
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">${signal.strategy_type}</div>
                            <div class="text-xs text-gray-500">R:R ${signal.risk_reward_ratio || 'N/A'}:1</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-xs text-gray-600">Target</div>
                            <div class="font-semibold text-green-600">‚Çπ${signal.target_price}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-600">Stop Loss</div>
                            <div class="font-semibold text-red-600">‚Çπ${signal.stop_loss}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-600">Score</div>
                            <div class="font-semibold">${Math.round(signal.trade_score || 0)}/100</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="text-sm font-semibold text-gray-800 mb-1">Probability Factors:</div>
                        <div class="text-xs text-gray-600">
                            ${(signal.probability_factors || []).slice(0, 3).join(' ‚Ä¢ ')}
                        </div>
                    </div>

                    <div class="text-sm text-gray-700 mb-3">
                        <strong>AI Analysis:</strong> ${signal.reasoning}
                    </div>

                    <div class="flex justify-between items-center mb-3">
                        <div class="text-xs text-gray-500">
                            <span>Expires: ${signal.expiry_date}</span>
                        </div>
                        <button onclick="takeTradePrompt(${signal.id})" 
                                class="take-trade-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded text-sm">
                            Take This Trade
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function takeTradePrompt(signalId) {
            const entryPrice = prompt('Enter your entry price (‚Çπ):');
            const quantity = prompt('Enter quantity (lots):', '1');

            if (entryPrice && quantity) {
                takeTradeAPI(signalId, parseFloat(entryPrice), parseInt(quantity));
            }
        }

        function takeTradeAPI(signalId, entryPrice, quantity) {
            fetch('/api/trades/take', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    signal_id: signalId,
                    entry_price: entryPrice,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Trade taken successfully! You will receive real-time alerts.');
                    loadActiveTrades();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error taking trade:', error);
                alert('‚ùå Error taking trade. Please try again.');
            });
        }

        function loadActiveTrades() {
            fetch('/api/trades/active')
                .then(response => response.json())
                .then(trades => {
                    updateActiveTrades(trades);
                })
                .catch(error => {
                    console.error('Error loading active trades:', error);
                });
        }

        function updateActiveTrades(trades) {
            const container = document.getElementById('activeTradesContainer');

            if (!trades || trades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div class="text-2xl mb-2">üìä</div>
                        <p>No active trades</p>
                        <p class="text-sm">Take a high-probability signal to start trading!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = trades.map(trade => `
                <div class="trade-card p-4 border rounded-lg bg-blue-50 border-blue-200">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="trade-id bg-blue-500 text-white px-2 py-1 rounded text-xs">#${trade.id}</span>
                            <span class="signal-type bg-${trade.signal?.type === 'CALL' ? 'green' : 'red'}-500 text-white px-2 py-1 rounded text-xs">
                                ${trade.signal?.type || 'N/A'} ‚Çπ${trade.signal?.strike_price || 'N/A'}
                            </span>
                            <span class="pnl-badge ${trade.pnl_percent >= 0 ? 'bg-green-500' : 'bg-red-500'} text-white px-2 py-1 rounded text-xs">
                                ${trade.pnl_percent > 0 ? '+' : ''}${trade.pnl_percent.toFixed(1)}%
                            </span>
                        </div>
                        <button onclick="exitTrade(${trade.id})" 
                                class="exit-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">
                            Exit Trade
                        </button>
                    </div>

                    <div class="grid grid-cols-4 gap-3 mb-3 text-center">
                        <div>
                            <div class="text-xs text-gray-600">Entry</div>
                            <div class="font-semibold">‚Çπ${trade.entry_price}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-600">Current</div>
                            <div class="font-semibold">‚Çπ${trade.current_ltp.toFixed(2)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-600">P&L</div>
                            <div class="font-semibold ${trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ‚Çπ${trade.pnl > 0 ? '+' : ''}${trade.pnl.toFixed(2)}
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-600">Qty</div>
                            <div class="font-semibold">${trade.quantity}</div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-600">
                        <div class="flex justify-between">
                            <span>Target: ‚Çπ${trade.signal?.target_price || 'N/A'}</span>
                            <span>SL: ‚Çπ${trade.signal?.stop_loss || 'N/A'}</span>
                        </div>
                        <div class="mt-1">
                            Entry Time: ${new Date(trade.entry_time).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function exitTrade(tradeId) {
            const exitPrice = prompt('Enter exit price (‚Çπ):');

            if (exitPrice) {
                fetch(`/api/trades/${tradeId}/exit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        exit_price: parseFloat(exitPrice)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Trade exited! Final P&L: ‚Çπ${data.final_pnl.toFixed(2)} (${data.final_pnl_percent.toFixed(1)}%)`);
                        loadActiveTrades();
                    } else {
                        alert('‚ùå Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error exiting trade:', error);
                    alert('‚ùå Error exiting trade. Please try again.');
                });
            }
        }
</script>
{% endblock %}